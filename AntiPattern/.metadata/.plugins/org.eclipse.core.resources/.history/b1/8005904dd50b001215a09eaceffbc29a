package br.ufes.inf.nemo.ontouml.antipattern;

import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;

import org.eclipse.emf.common.util.URI;
import org.eclipse.emf.ecore.EClass;
import org.eclipse.emf.ecore.EClassifier;
import org.eclipse.emf.ecore.EEnumLiteral;
import org.eclipse.emf.ecore.EObject;
import org.eclipse.emf.ecore.EOperation;
import org.eclipse.emf.ecore.EPackage;
import org.eclipse.emf.ecore.EParameter;
import org.eclipse.emf.ecore.EStructuralFeature;

import org.eclipse.emf.ecore.resource.Resource;
import org.eclipse.emf.ecore.resource.ResourceSet;
import org.eclipse.emf.ecore.resource.impl.ResourceSetImpl;
import org.eclipse.emf.ecore.xmi.impl.XMIResourceFactoryImpl;

import org.eclipse.ocl.OCL;
import org.eclipse.ocl.ParserException;
import org.eclipse.ocl.Query;
import org.eclipse.ocl.ecore.CallOperationAction;
import org.eclipse.ocl.ecore.EcoreEnvironmentFactory;
import org.eclipse.ocl.ecore.SendSignalAction;
import org.eclipse.ocl.expressions.OCLExpression;
import org.eclipse.ocl.helper.OCLHelper;

import br.ufes.inf.nemo.ontouml.antipattern.mapper.NamesMapper;
import br.ufes.inf.nemo.ontouml.antipattern.util.Combinacao;

import RefOntoUML.Association;
import RefOntoUML.Mediation;
import RefOntoUML.Model;
import RefOntoUML.RefOntoUMLFactory;
import RefOntoUML.RefOntoUMLPackage;
import RefOntoUML.Relator;

public class QueryPerformer {
	public static void main(String[] args) {
		OCLExpression<EClassifier> query = null;

		ResourceSet resourceSet = new ResourceSetImpl();
		// Register the default resource factory -- only needed for stand-alone!
		RefOntoUMLPackage refMetaPack = RefOntoUMLPackage.eINSTANCE;
		resourceSet.getResourceFactoryRegistry().getExtensionToFactoryMap().put(Resource.Factory.Registry.DEFAULT_EXTENSION, new XMIResourceFactoryImpl());
		// Get the URI of the model file.
		URI fileURI = URI.createFileURI(new File("models/XML Models/Surgery.xmi").getAbsolutePath());
		// Demand load the resource for this file.
		Resource resource = resourceSet.getResource(fileURI, true);
		
		// Print the contents of the resource to System.out. 
		RefOntoUMLFactory factory = RefOntoUMLFactory.eINSTANCE;
		Model m = factory.createModel();
		
		m = (Model) resource.getContents().get(0);
		
		NamesMapper mapper = new NamesMapper(m);
			
		try {
		    	    
		    /*query = helper.createQuery(SelfTypeRelationship.OCLQuery); 

		    eval = ocl.createQuery(query);
		    
		    Collection<Association> result = (Collection<Association>) eval.evaluate(m);
		    
		    String type;
		    String association;
		    String cardinality = "4";
		    
		    for (Association c : result) {
		    	type = mapper.elementsMap.get(c.getOwnedEnd().get(0).getType());
		    	association = mapper.elementsMap.get(c);
		    	  	
		    	System.out.println(SelfTypeRelationship.SymmetricAlloyPredicate(type, association, cardinality));
		    	System.out.println(SelfTypeRelationship.AntisymmetricAlloyPredicate(type, association, cardinality));
		    	System.out.println(SelfTypeRelationship.ReflexiveAlloyPredicate(type, association, cardinality));
				System.out.println(SelfTypeRelationship.IrreflexiveAlloyPredicate(type, association, cardinality));
		    	System.out.println(SelfTypeRelationship.TransitiveAlloyPredicate(type, association, cardinality));
		    	System.out.println(SelfTypeRelationship.IntransitiveAlloyPredicate(type, association, cardinality));
		    	
		    }*/
		    
		    Collection<Relator>result2 = RBOSIdentifier.RBOSRelatorQuery(refMetaPack, m);
		    System.out.println(result2.size());
	
		    for (Relator c : result2) {
		    	//System.out.println(RBOS.ExclusiveRolesAlloyPredicate(c, mapper));
		    	System.out.println(RBOS.NonExclusiveRolesAlloyPredicate(c, mapper));
		    	System.out.println(RBOS.MultipleExclusiveRolesAlloyPredicate(c,mapper));

		    }
		    		    
		} catch (ParserException e) {
		    // record failure to parse
		    //valid = false;
		    System.err.println(e.getLocalizedMessage());
		}
		
        
	}
}